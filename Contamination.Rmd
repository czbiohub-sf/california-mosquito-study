---
title: "Contamination"
output: html_document
---

Contamination, from the lab-ome and from other samples, is real. This shows up as human and mouse everywhere, and also a bimodal distribution for many key pathogens from the dataset (Wuhan Virus 6, Wolbachia, etc).

We plot rpm (in whole dataset) vs 1/percent_ercc, and observe the characteristic downward trend of the labome.

The data we have access to are:

reports (NT reads)
contigs (kicked up the tree to LCA)

sample table (total ERCCs, total reads)
preparation table (input mass, batch information)
host species table


```{r}
library(taxizedb)
library(tidyverse)
library(purrr)
library(ggplot2)
library(taxize)
library(usethis)
```

```{r}
setwd('~/src/skeeters') 
```

```{r}
report = read_csv('data/mosquito_reports.csv')
```

```{r}
sample_table = read_csv('data/project-mosquito_sample-table.csv')
report %>% left_join(sample_table %>% select(sample_name, total_reads, nonhost_reads, total_ercc_reads) %>%
  mutate(percent_ercc = total_ercc_reads/total_reads), on = sample_name)
```


```{r}
plot_genus = function(taxid) {
  name = report %>% filter(tax_level == 2, genus_taxid == taxid) %>% pull(name) %>% first()
  report %>% filter(tax_level == 1, genus_taxid == taxid, NT_percentidentity > 85) %>% group_by(sample_name) %>% 
    summarize(reads = sum(NT_r), water = first(water)) %>% 
    left_join(sample_table %>% select(sample_name, total_reads, total_ercc_reads) , by='sample_name') %>%
    mutate(rpm = reads/total_reads*1e6, percent_ercc = total_ercc_reads/total_reads) %>% 
    mutate(mass = 1/percent_ercc - 1) %>% drop_na(percent_ercc) %>%
  
    ggplot(aes(x = mass, y = rpm, color = water)) + scale_x_log10() + scale_y_log10() + geom_point() + ggtitle(name)
}

plot_species = function(taxid) {
  name = report %>% filter(tax_level == 1, species_taxid == taxid) %>% pull(name) %>% first()
  report %>% filter(species_taxid == taxid, NT_percentidentity > 85) %>% group_by(sample_name) %>% 
    summarize(reads = sum(NT_r), water = first(water)) %>% 
    left_join(sample_table %>% select(sample_name, total_reads, total_ercc_reads) , by='sample_name') %>%
    mutate(rpm = reads/total_reads*1e6, percent_ercc = total_ercc_reads/total_reads) %>% 
    mutate(mass = 1/percent_ercc - 1) %>% drop_na(percent_ercc) %>%
  
    ggplot(aes(x = mass, y = rpm, color = water)) + scale_x_log10() + scale_y_log10() + geom_point() + ggtitle(name)
}

plot_family = function(taxid) {
  name = report %>% filter(family_taxid == taxid) %>% pull(name) %>% first()
  report %>% filter(family_taxid == taxid, NT_percentidentity > 85) %>% group_by(sample_name) %>% 
    summarize(reads = sum(NT_r), water = first(water)) %>% 
    left_join(sample_table %>% select(sample_name, total_reads, total_ercc_reads) , by='sample_name') %>%
    mutate(rpm = reads/total_reads*1e6, percent_ercc = total_ercc_reads/total_reads) %>% 
    mutate(mass = 1/percent_ercc - 1) %>% drop_na(percent_ercc) %>%
  
    ggplot(aes(x = mass, y = rpm, color = water)) + scale_x_log10() + scale_y_log10() + geom_point() + ggtitle(name)
}
```

```{r}
plot_genus(5658)
plot_genus(953)
plot_species(9606)
plot_species(10090)
plot_genus(547)
plot_genus(768)
plot_species(1608131)
plot_species(1628188)
plot_species(2230910)
plot_species(2079148)
```

```{r}
plot_family(5654)
plot_genus(5655)
```


For viral contigs, we seem to be fine. Meaning that bimodal distribution of rpm matches samples w/ contigs assembling vs samples without.

For eukaryotes and bacteria, this may be harder. Trypanosomes present some clear yes some clear no and some borderline cases.

Wolbachia, since we are going to talk about it, we should do a close analysis.

1. Batch correlations
2. Host species
3. Look at contig coverage instead of just rpm
4. For some samples, there is a clear bimodal distribution of rpm. This may just be viruses.
5. Color this plot by number or total length or coverage of contigs

Trypanosome example 

## Are there some common bad samples?

Are the samples with low rpm of Wuhan and Narna the same? No.

```{r}
report %>% filter(str_detect(name, "Narna")) %>% filter(tax_id == 1628188) %>% left_join(sample_table %>% select(sample_name, total_reads, total_ercc_reads) , by='sample_name') %>%
    mutate(rpm = NT_r/total_reads*1e6, percent_ercc = total_ercc_reads/total_reads) %>% ggplot(aes(rpm)) + geom_freqpoly() + scale_x_log10()
low_narna = report %>% filter(str_detect(name, "Narna")) %>% filter(tax_id == 1628188) %>% left_join(sample_table %>% select(sample_name, total_reads, total_ercc_reads) , by='sample_name') %>%
    mutate(rpm = NT_r/total_reads*1e6, percent_ercc = total_ercc_reads/total_reads) %>% filter(rpm < 1 & rpm > 0) %>% pull(sample_name)
```

```{r}
report %>% filter(tax_id == 1608131) %>% left_join(sample_table %>% select(sample_name, total_reads, total_ercc_reads) , by='sample_name') %>%
    mutate(rpm = NT_r/total_reads*1e6, percent_ercc = total_ercc_reads/total_reads) %>% ggplot(aes(rpm)) + geom_freqpoly() + scale_x_log10()

low_wuhan = report %>% filter(tax_id == 1608131) %>% left_join(sample_table %>% select(sample_name, total_reads, total_ercc_reads) , by='sample_name') %>%
    mutate(rpm = NT_r/total_reads*1e6, percent_ercc = total_ercc_reads/total_reads) %>% filter(rpm < 1 & rpm >0) %>% pull(sample_name)

length(low_narna)
length(low_wuhan)
intersect(low_narna, low_wuhan)
```

## Do contigs tell the same story?

```{r}
contig_df = read_tsv('~/src/skeeters/data/contig_quality_df.tsv')
```


```{r}
contig_df %>% filter(str_detect(scientific_name, "rypano")) 
```

### Trypanosomes

```{r}
trypano_contigs = contig_df %>% filter(str_detect(scientific_name, "rypano")) %>% filter(pmatch_gsnap > 0.85) %>% mutate(sample_name = sample) %>% group_by(sample_name) %>%
  summarize(total_length = sum(qlength), n_contigs = n())
trypano_contigs
```

```{r}
trypano_reads = report %>% filter(family_taxid == 5654, NT_percentidentity > 85) %>% group_by(sample_name) %>% 
    summarize(reads = sum(NT_r), water = first(water)) %>% 
    left_join(sample_table %>% select(sample_name, total_reads, total_ercc_reads) , by='sample_name') %>%
    mutate(rpm = reads/total_reads*1e6, percent_ercc = total_ercc_reads/total_reads) %>% 
    mutate(mass = 1/percent_ercc - 1) %>% arrange(desc(rpm))
```

```{r}
hybrd.rplc_if    <- function(x) { mutate_if(x, is.numeric, funs(replace(., is.na(.), 0))) }
```

```{r}
trypano_contigs %>% full_join(trypano_reads) %>% hybrd.rplc_if %>%
  ggplot(aes(reads, total_length, color=n_contigs)) + geom_point() + scale_x_log10()
```

