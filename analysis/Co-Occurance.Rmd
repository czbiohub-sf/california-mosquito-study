---
title: "Association Testing"
output: html_notebook
---

# Association Testing

We seek to find associations between taxa, a permutation test for species A being enriched in samples containg species B. In particular, we want to find microbiota associated with bloodmeals.

The correct test is hypergeometric. If there are m white balls (ungulates) and n black balls (non-ungulates) and we draw k samples (anaplasma) what are the chances we draw at least q white balls (ungulates with anaplasma)?

```{r}
library(taxizedb)
library(tidyverse)
library(purrr)
library(ggplot2)
library(taxize)
```

```{r}
data_dir <- "../data"
```

```{r}
contig_reads = read_tsv(file.path(data_dir, 's3/contig_quality_concat/decontam_sample_read_counts.tsv'))

select_taxa = read_tsv(file.path('../figures/fig3/all_contigs_df.tsv'))
vertebrates = read_csv(file.path('../figures/fig4/vertebrate_lat.csv'))
```

```{r}
select_taxa %>% select(sample, sci_name) %>% filter(str_detect(sci_name, 'rypan')) %>% 
  group_by(sample) %>% count()
```


```{r}
all_samples = unique(df %>% filter(!str_detect(tolower(sample), 'water')) %>% pull(sample))
cms001_samples = unique(df %>% filter(str_detect(sample, 'CMS001')) %>% pull(sample))

vertebrates = vertebrates %>% filter(sample %in% cms001_samples)
```


```{r}
has_anaplasma = contig_reads %>% filter(taxid == 768) %>% pull(sample)
has_orbi = c('CMS001_012_Ra_S4')
```


We detect bloodmeals in 46 out of 60 samples.

```{r}
vertebrates %>% mutate(anaplasma = sample %in% has_anaplasma,
                                                orbi = sample %in% has_orbi) %>% 
  group_by(category) %>% summarize(count = n(), ana = sum(anaplasma), orbi = sum(orbi)) %>% arrange(desc(count))
```

```{r}
vertebrates %>% group_by(category) %>% count() %>% 
  ggplot(aes(x = reorder(category, -n), y = n)) + geom_col()
```


```{r}
vertebrates %>% mutate(anaplasma = sample %in% has_anaplasma,
                                                orbi = sample %in% has_orbi) %>% 
  group_by(category, name) %>% summarize(count = n(), ana = sum(anaplasma), orbi = sum(orbi))
```


```{r}
association <- function(df, query, sample_subset = all_samples, p_filter=0.05){
  has_query = df %>% filter(sci_name == query) %>% filter(sample %in% sample_subset) %>% pull(sample)

  n_query = length(has_query)
  n_samples = length(sample_subset)

  p_values = df %>% filter(sample %in% sample_subset) %>% mutate(query = sample %in% has_query) %>% 
    group_by(sci_name) %>% summarize(n_taxon = n(), n_intersect = sum(query)) %>%
    mutate(p = phyper(n_intersect - 1, n_query, n_samples - n_query, n_taxon, lower.tail=FALSE)) %>%  arrange(p)
  p_values %>% mutate(p_adj = p*nrow(p_values)) %>% filter(p_adj < p_filter)
}
```

```{r}
association(vertebrates, "Wolbachieae", cms001_samples)
```

```{r}
association(select_taxa, "Bovidae")
```

```{r}
association_with <- function(df, has_query, sample_subset = all_samples, p_filter=0.05){
  n_query = length(has_query)
  n_samples = length(sample_subset)

  p_values = df %>% filter(sample %in% sample_subset) %>% mutate(query = sample %in% has_query) %>% 
    group_by(sci_name) %>% summarize(n_taxon = n(), n_intersect = sum(query)) %>%
    mutate(p = phyper(n_intersect - 1, n_query, n_samples - n_query, n_taxon, lower.tail=FALSE)) %>%  arrange(p)
  p_values %>% mutate(p_adj = p*nrow(p_values)) %>% filter(p_adj < p_filter)
}
```


```{r}
has_anaplasma = contig_reads %>% filter(taxid == 768) %>% pull(sample)
association_with(select_taxa, has_anaplasma, cms001_samples)
```

```{r}
read_csv('~/src/skeeters/figures/fig4/vertebrate_lat.csv') %>% mutate(anaplasma = sample %in% has_anaplasma) %>%
  arrange(desc(anaplasma))
```


```{r}
length(has_anaplasma)
```

```{r}
association_with(select_taxa, has_anaplasma, cms001_samples)
```


Note Odocoileinae and Bovidae are the only Metazoa co-occuring with Anaplasma.

```{r}
has_ung = select_taxa %>% filter(sample %in% cms001_samples) %>%
  filter(sci_name %in% c('Odocoileinae', 'Bovidae')) %>% pull(sample) %>% unique()

select_taxa %>% filter(sample %in% cms001_samples) %>% filter(sample %in% has_anaplasma) %>% 
  filter(group=='Metazoa')
```


Stratification TK.

```{r}
stratify_association <- function(df, query, stratify_by, sample_subset = all_samples, p_filter=0.05){
  has_query = df %>% filter(sci_name == query) %>% filter(sample %in% sample_subset) %>% pull(sample)

  sample_df = df %>% filter(sci_name == query)
  n_query = length(has_query)
  n_samples = length(sample_subset)

  p_values = df %>% filter(sample %in% sample_subset) %>% mutate(query = sample %in% has_query) %>% 
    group_by_at(c(stratify_by, 'sci_name')) %>% 
    summarize(n_taxon = n(), n_intersect = sum(query)) %>%
    mutate(p = phyper(n_intersect - 1, n_query, n_samples - n_query, n_taxon, lower.tail=FALSE)) %>%  arrange(p)
  p_values %>% mutate(p_adj = p*nrow(p_values)) %>% filter(p_adj < p_filter)
}
```

```{r}
select_taxa
select_taxa %>% filter(group=='Metazoa') %>% 
  ggplot(aes(x = sample, y = read_prop, c = sci_name))
```


```{r}
stratify_association(select_taxa, "Wolbachieae", 'ska_species', cms001_samples)
```

```{r}
cows_vs_deer = select_taxa %>% filter(sci_name %in% c("Bovidae", "Odocoileinae")) %>% 
  select(sci_name, sample, read_prop) %>% spread(sci_name, read_prop, fill=0) %>%
  mutate(Odocoileinae/Bovidae)
cows_vs_deer %>%  ggplot(aes(x=Bovidae, y=Odocoileinae)) + geom_point() + geom_abline(slope=1)
```
```{r}
cows_vs_deer %>% arrange(desc(Odocoileinae))
```

