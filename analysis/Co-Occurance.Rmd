---
title: "Association Testing"
output: html_notebook
---

# Association Testing

We seek to find associations between taxa, a permutation test for species A being enriched in samples containg species B. In particular, we want to find microbiota associated with bloodmeals.

The correct test is hypergeometric. If there are m white balls (ungulates) and n black balls (non-ungulates) and we draw k samples (anaplasma) what are the chances we draw at least q white balls (ungulates with anaplasma)?

```{r}
library(taxizedb)
library(tidyverse)
library(purrr)
library(ggplot2)
library(taxize)
```

```{r}
data_dir <- "../data"
```

```{r}
contig_reads = read_tsv(file.path(data_dir, 's3/contig_quality_concat/decontam_sample_read_counts.tsv'))
select_taxa = read_tsv(file.path('../figures/fig3/all_contigs_df.tsv'))
```

```{r}
select_taxa %>% filter(group == 'Metazoa') %>% pull(sci_name) %>% unique()
```


```{r}
all_samples = unique(df %>% filter(!str_detect(tolower(sample), 'water')) %>% pull(sample))
cms001_samples = unique(df %>% filter(str_detect(sample, 'CMS001')) %>% pull(sample))
```

```{r}
association <- function(df, query, sample_subset = all_samples, p_filter=0.05){
  has_query = df %>% filter(sci_name == query) %>% filter(sample %in% sample_subset) %>% pull(sample)

  n_query = length(has_query)
  n_samples = length(sample_subset)

  p_values = df %>% filter(sample %in% sample_subset) %>% mutate(query = sample %in% has_query) %>% 
    group_by(sci_name) %>% summarize(n_taxon = n(), n_intersect = sum(query)) %>%
    mutate(p = phyper(n_intersect - 1, n_query, n_samples - n_query, n_taxon, lower.tail=FALSE)) %>%  arrange(p)
  p_values %>% mutate(p_adj = p*nrow(p_values)) %>% filter(p_adj < p_filter)
}
```

```{r}
association(select_taxa, "Wolbachieae", cms001_samples)
```

```{r}
association(select_taxa, "Plasmodium")
```

```{r}
association_with <- function(df, has_query, sample_subset = all_samples, p_filter=0.05){
  n_query = length(has_query)
  n_samples = length(sample_subset)

  p_values = df %>% filter(sample %in% sample_subset) %>% mutate(query = sample %in% has_query) %>% 
    group_by(sci_name) %>% summarize(n_taxon = n(), n_intersect = sum(query)) %>%
    mutate(p = phyper(n_intersect - 1, n_query, n_samples - n_query, n_taxon, lower.tail=FALSE)) %>%  arrange(p)
  p_values %>% mutate(p_adj = p*nrow(p_values)) %>% filter(p_adj < p_filter)
}
```

```{r}
has_anaplasma = contig_reads %>% filter(taxid == 768) %>% pull(sample)
association_with(select_taxa, has_anaplasma, cms001_samples)
```

Note Odocoileinae and Bovidae are the only Metazoa co-occuring with Anaplasma.

```{r}
has_ung = select_taxa %>% filter(sample %in% cms001_samples) %>%
  filter(sci_name %in% c('Odocoileinae', 'Bovidae')) %>% pull(sample) %>% unique()

select_taxa %>% filter(sample %in% cms001_samples) %>% filter(sample %in% has_anaplasma) %>% 
  filter(group=='Metazoa')
```


Stratification TK.

```{r}
stratify_association <- function(df, query, stratify_by, sample_subset = all_samples, p_filter=0.05){
  has_query = df %>% filter(sci_name == query) %>% filter(sample %in% sample_subset) %>% pull(sample)

  sample_df = df %>% filter(sci_name == query)
  n_query = length(has_query)
  n_samples = length(sample_subset)

  p_values = df %>% filter(sample %in% sample_subset) %>% mutate(query = sample %in% has_query) %>% 
    group_by_at(c(stratify_by, 'sci_name')) %>% 
    summarize(n_taxon = n(), n_intersect = sum(query)) %>%
    mutate(p = phyper(n_intersect - 1, n_query, n_samples - n_query, n_taxon, lower.tail=FALSE)) %>%  arrange(p)
  p_values %>% mutate(p_adj = p*nrow(p_values)) %>% filter(p_adj < p_filter)
}
```

```{r}
stratify_association(select_taxa, "Wolbachieae", 'ska_species', cms001_samples)
```
