---
title: "R Notebook"
output: html_notebook
---

```{r}
knitr::opts_chunk$set(root.dir='~/src/skeeters')
library(taxizedb)
library(tidyverse)
library(purrr)
library(ggplot2)
library(decontam)
library(forcats)
```

```{r}
data_dir = '../data'
```

```{r}
sample_table = read_csv(file.path(data_dir, 'idseq_metadata.csv'))
head(sample_table)
```

Approximate input concentration (up to a constant factor) by ratio of reads to ERCCs.

```{r}
sample_table = sample_table %>% mutate(water = str_detect(sample, 'ater')) %>%
  select(sample, total_reads, nonhost_reads, total_ercc_reads, compression_ratio, water) %>%
  mutate(input_conc = (total_reads - total_ercc_reads)/total_ercc_reads, nonhost_frac = nonhost_reads*compression_ratio/total_reads)
```

Load reads-mapping-to-contigs, together with contig LCAs.

```{r}
contig_reads = read_tsv(file.path(data_dir, 's3/contig_quality_concat/contig_stats_lca.tsv'))
read_counts = contig_reads %>% group_by(taxid, sample) %>% summarize(reads = sum(read_count))
```

Hubei MV 2: 1922926
Wuhan 6: 1608131
Wuhan 9: 1608134
narna: 1628188
culex iflavi-like virus 4: 2304480
mouse: 10090

Plot relationship of relative abundance (RPM) to input RNA concentration. For contaminants, this should be approx linear.

```{r}
read_counts %>% left_join(sample_table, by='sample') %>% mutate(rpm = reads/total_reads*1e6) %>%
  select(sample, taxid, input_conc, rpm, water, total_ercc_reads, reads) %>%
    filter((taxid == '10090')) %>% 
ggplot(aes(x = log10(input_conc), y=log10(rpm), color=water)) + geom_point()
```

Markov correction for background. We compute the average concentration of each taxon in the water. Markov's inequality says that for any nonnegative random variable X, the probability that X is greater k is less than EX/k. Thus for any false-discovery rate r, the probability that X > EX/r is less than EX/(EX/r) = r. If we treat concentrations of contaminating taxa in each well as a random variable, we can estimate the mean from the water, and use that estimate to bound (using Markov's inequality), the amount of that taxon contained in another sample can be explained by contamination.

```{r}
fdr = 0.01
n_water = length(sample_table %>% filter(water))

background_levels = read_counts %>% left_join(sample_table, by='sample') %>% filter(water) %>%
  mutate(r_per_ercc = reads*compression_ratio/total_ercc_reads) %>%
  group_by(taxid) %>% summarize(background_rate = sum(r_per_ercc)/n_water)

df = read_counts %>% left_join(sample_table, by='sample') %>% filter(!water) %>%
  left_join(background_levels, by='taxid') %>% mutate(background_reads=total_ercc_reads*background_rate/compression_ratio)
  
decontam_read_counts = df %>% filter(reads > background_reads/fdr) %>% select(sample, taxid, reads)

contamination = df %>% filter(reads < background_reads/fdr) %>% select(sample, taxid)
```

```{r}
decontam_read_counts %>% filter(taxid == '1608131')
```

What was removed as contamination?

```{r}
contamination %>% group_by(taxid) %>% summarize(n_samples = n(), n_reads = sum(reads)) %>% arrange(desc(n_samples))
```

```{r}
contamination %>% write_tsv(file.path(data_dir, 's3/contig_quality_concat/sample_contamination.tsv'))
decontam_read_counts %>% write_tsv(file.path(data_dir, 's3/contig_quality_concat/decontam_sample_read_counts.tsv'))
```


# Scratch

Repeat the same analysis with reads.

```{r}
report = read_csv(file.path(data_dir, 'idseq_reports/idseq_reports.csv'))
report = report %>% rename(taxon = name, sample=sample_name) %>% select(-water)
```

```{r}
report %>% left_join(sample_table, by='sample') %>% mutate(density = NT_r/input_conc) %>%
  select(sample, taxon, input_conc, density, water, total_ercc_reads, NT_r) %>%
  #filter(str_detect(taxon, 'Wuhan Mosquito Virus 6')) %>% 
  filter(str_detect(taxon, 'Mus')) %>% 
ggplot(aes(x = log10(input_conc), y=log10(density), color=water)) + geom_point() + facet_wrap(~taxon)
```


```{r}
metadata = read_csv(file.path(data_dir, 'metadata/CMS001_CMS002_MergedAnnotations.csv')) %>% mutate(sample=NewIDseqName)
metadata
```

