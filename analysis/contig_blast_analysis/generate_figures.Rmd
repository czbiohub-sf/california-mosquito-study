---
title: "Generate figures"
author: "Lucy M. Li"
date: "`r format(Sys.Date(), '%b %d, %Y')`"
output: 
  html_document:
    fig_caption: yes
---


# Notebook setup

Run this notebook after running the generate_figures.ipynb jupyter notebook.

```{r setup, include=FALSE}
# List of packages to load
pkgs <- c("parallel", "dplyr", "tidyr", "readr", "magrittr", "ggplot2", "grid", "gridExtra", "stringr", "reutils", "rjson", "knitr", "taxize", "aws.s3", "RColorBrewer", "scales", "gtable")
# Install any packages not yet installed
if (any(!(pkgs %in% rownames(installed.packages())))) {
  invisible(sapply(pkgs[!(pkgs %in% rownames(installed.packages()))], install.packages))
}
# Load the libraries
invisible(sapply(pkgs, library, character.only=TRUE))
# R Markdown options
knitr::opts_chunk$set(echo=TRUE)
```

```{r directories}
data_dir <- "../../data/metadata"
fig_dir <- "../../figures/fig3"
if (!dir.exists(data_dir)) dir.create(data_dir)
if (!dir.exists(fig_dir)) dir.create(fig_dir)
```


```{r scripts}
source("generate_figures_functions.R")
```

# Metadata

```{r load_data, message=FALSE}
metadata_file_path <- list.files(data_dir, "CMS001_CMS002_Merged", full.names = TRUE)
metadata <- read.csv(metadata_file_path, stringsAsFactors = FALSE) %>%
  mutate(collected_by=gsub(" ", "", collected_by)) %>%
  mutate(collection_date=as.Date(collection_date)) %>%
  mutate(ska_genus_species=paste(ska_genus, ska_species)) %>%
  left_join(read_csv(file.path(data_dir, "../project-mosquito_sample-table.csv")), by=c("NewIDseqName"="sample_name"))
```


# Read in data



```{r read_in_data, message=FALSE, warning=FALSE}
curated_contigs <- read_tsv(file.path(fig_dir, "all_contigs_df.tsv")) %>%
  mutate(collected_by=factor(collected_by, levels=c("PLCR", "ALCO",  "WVAL", "COAV", "SAND")),
         group=factor(group, levels=c("Virus", "Wolbachia", "Metazoa", "Other Eukaryotes")))
curated_contigs <- curated_contigs %>% 
  filter(group=="Virus") %>% 
  group_by(sample) %>% 
  summarize(read_prop_virus=sum(read_prop)) %>%
  left_join(curated_contigs, .) %>%
  arrange(group, ska_genus, ska_species, desc(collected_by), desc(read_prop_virus)) %>%
  mutate(sample_short=str_split(as.character(sample), "_", simplify=FALSE) %>% 
           lapply(head, 2) %>% 
           sapply(paste, collapse="_") %>%
           gsub("CMS00", "", .)) %>% 
  mutate(sample_short=factor(sample_short, levels=unique(sample_short))) %>%
  left_join(metadata%>%select(NewIDseqName, nonhost_reads), by=c("sample"="NewIDseqName")) %>%
  mutate(sci_name=gsub("Virus", "Other viruses", sci_name))

curated_virus_wolbachia_df <- filter(curated_contigs, group %in% c("Virus", "Wolbachia")) %>%
  mutate(sample=factor(sample), sample_short=factor(sample_short)) %>%
  mutate(baltimore_group=replace_na(baltimore_group, "Wolbachia"))
```


# Plot results


```{r plot_color_palette, message=FALSE}
color_ranges <- c(Unknown="Purples", III="Blues", IV="YlOrRd", V="Greens") %>% 
  sapply(function (x) RColorBrewer::brewer.pal(3, x)) %>%
  `[`(., c(1, 3), ) %>%
  data.frame(stringsAsFactors=FALSE)
color_palette <- split(curated_virus_wolbachia_df$sci_name, ) %>% 
  lapply(unique) %>%
  mapply(function (i, x) {
    if (i=="Wolbachia") {
      colors <- c("gray20")
    } else {
      colors <- colorRampPalette(color_ranges[[i]])(length(x))
    }
    names(colors) <- x
    colors
  }, names(.), ., SIMPLIFY=FALSE) %>%
  do.call(what=c) %>%
  setNames(., strsplit(names(.), ".", fixed=TRUE) %>% sapply(tail, 1))
collected_by_colours <- c(ALCO=hsl_to_rgb(0.49803923567136127, 0.43267975250879925, 0.52287583549817396), ## purple\n"
                          WVAL=hsl_to_rgb(0.88366013765335083, 0.77908497055371606, 0.18562091886997223), ## yellow\n",
                          COAV=hsl_to_rgb(0.8162552973803352, 0.41062668737243202, 0.29078047883276847), ## red\n",
                          PLACER=hsl_to_rgb(0.28098424626331703, 0.63955403192370541, 0.39507882933990629), ## green\n",
                          SAND=hsl_to_rgb(0.4666666666666667, 0.7450980392156863, 0.8588235294117647), ## light blue\n",
                          "NA"="#C0C0C0")
```




```{r plot_data, message=FALSE}
base_plot <- 
  ggplot(curated_virus_wolbachia_df, aes(x=sample_short, y=read_prop, fill=sci_name)) +
  theme_bw() + 
  geom_bar(stat="identity", position="stack") +
  facet_grid(group~ska_genus+ska_species+collected_by, scales='free', space="free") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual("", breaks=names(color_palette), values=color_palette, labels=names(color_palette)) +
  ylab("% of nonhost reads") +
  xlab("sample ID") +
  theme(axis.text.x=element_text(angle=90, hjust=1), 
        legend.position="none",
        strip.text.y=element_text(angle=0),
        panel.spacing=unit(0, "lines"),
        axis.title.y=element_text(angle=0, vjust=0.5),
        text=element_text(size=16))
plot_grob <- ggplotGrob(base_plot)
plot_grob$heights[10] <- unit(0.2, "null")
```

```{r plot_legends}
# Extract legends as separate plots
legends <- split(curated_virus_wolbachia_df, curated_virus_wolbachia_df$baltimore_group) %>%
  lapply(function (dataframe) {
    selected_colours <- names(color_palette) %in% as.character(dataframe$sci_name)
    subpalette <- color_palette[selected_colours]
    sublabels <- subbreaks <- names(color_palette)[selected_colours]
    temp_plot <- ggplot(dataframe, aes(x=sample_short, y=read_prop, fill=sci_name)) +
      theme_bw() +
      geom_bar(stat="identity", position="stack") +
      scale_fill_manual(dataframe$genome_description[1], breaks=subbreaks, labels=sublabels, values=subpalette) +
      theme(text=element_text(size=12))
    plot_gtable <- ggplot_gtable(ggplot_build(temp_plot))
    leg <- which(sapply(plot_gtable$grobs, function(x) x$name) == "guide-box") 
    plot_gtable$grobs[[leg]]
  })
```

```{r save_plot}
full_plot <- arrangeGrob(plot_grob, do.call(what=rbind, legends[1:4]), nrow=1, widths=c(8, 2))
ggsave(file.path(fig_dir, "fig3.pdf"), full_plot, width=25, height=10)
```

## Save output

```{r output}
save.image(file="generate_figures.RData")
```

