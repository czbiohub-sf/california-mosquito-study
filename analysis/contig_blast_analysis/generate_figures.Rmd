---
title: "Generate figures"
author: "Lucy M. Li"
date: "`r format(Sys.Date(), '%b %d, %Y')`"
output: 
  html_document:
    fig_caption: yes
---


# Notebook setup

Run this notebook after running the generate_figures.ipynb jupyter notebook.

```{r setup, include=FALSE}
# List of packages to load
pkgs <- c("dplyr", "tidyr", "readr", "magrittr", "ggplot2", "grid", "gridExtra", "stringr", "knitr", "scales", "gtable")
# Install any packages not yet installed
if (any(!(pkgs %in% rownames(installed.packages())))) {
  invisible(sapply(pkgs[!(pkgs %in% rownames(installed.packages()))], install.packages))
}
# Load the libraries
invisible(sapply(pkgs, library, character.only=TRUE))
# R Markdown options
knitr::opts_chunk$set(echo=TRUE)
```

```{r directories}
data_dir <- "../../data/metadata"
fig_dir <- "../../figures/fig3"
if (!dir.exists(data_dir)) dir.create(data_dir)
if (!dir.exists(fig_dir)) dir.create(fig_dir)
# helvetica neue - font from other figures.
```


```{r scripts}
source("generate_figures_functions.R")
```

# Metadata

```{r load_data, message=FALSE}
metadata_file_path <- list.files(data_dir, "CMS001_CMS002_Merged", full.names = TRUE)
metadata <- read.csv(metadata_file_path, stringsAsFactors = FALSE) %>%
  mutate(collected_by=gsub(" ", "", collected_by)) %>%
  mutate(collection_date=as.Date(collection_date)) %>%
  mutate(ska_genus_species=paste(ska_genus, ska_species)) %>%
  left_join(read_csv(file.path(data_dir, "../metadata/idseq_metadata.csv")), by=c("NewIDseqName"="sample"))
```


# Read in data



```{r read_in_data, message=FALSE, warning=FALSE}
all_curated_contigs <- read_tsv(file.path(fig_dir, "all_contigs_df.tsv")) %>%
  mutate(collected_by=factor(collected_by, levels=c("PLCR", "ALCO",  "WVAL", "COAV", "SAND")),
         group=factor(group, levels=c("Virus", "Wolbachia", "Metazoa", "Other Eukaryotes")))
all_curated_contigs <- all_curated_contigs %>% 
  filter(group=="Virus") %>% 
  group_by(sample) %>% 
  summarize(read_prop_virus=sum(read_prop)) %>%
  left_join(all_curated_contigs, .) %>%
  ungroup() %>%
  arrange(group, ska_genus, ska_species, collected_by, desc(read_prop_virus)) %>%
  mutate(sample_short=str_split(as.character(sample), "_", simplify=FALSE) %>% 
           lapply(head, 2) %>% 
           sapply(paste, collapse="_") %>%
           gsub("CMS00", "", .)) %>% 
  mutate(sample_short=factor(sample_short, levels=unique(sample_short))) %>%
  left_join(metadata%>%select(NewIDseqName, nonhost_reads), by=c("sample"="NewIDseqName")) %>%
  mutate(sci_name=gsub("Virus", "Other viruses", sci_name))


all_curated_contigs[is.na(all_curated_contigs$ska_species), paste0("ska_", c("genus", "species"))] <-
  filter(all_curated_contigs, is.na(ska_species)) %>%
  `[[`("sample") %>% match(metadata$NewIDseqName) %>%
  slice(metadata, .) %>%
  select(visual_genus, visual_species) %>%
  rename(ska_genus=visual_genus, ska_species=visual_species)

curated_contigs <- filter(all_curated_contigs, group %in% c("Virus", "Wolbachia", "Other Eukaryotes")) %>%
  mutate(group=factor(droplevels(group), c("Virus", "Wolbachia", "Other Eukaryotes"))) %>%
  mutate(sample=factor(sample), sample_short=factor(sample_short)) %>%
  mutate(baltimore_group=coalesce(baltimore_group, as.character(group))) %>%
  mutate(family=coalesce(family, as.character(group))) %>%
  mutate(genome_description=coalesce(genome_description, as.character(group))) %>%
  filter(family!="Other eukaryotes")

subset_contigs <- curated_contigs %>%
  group_by(sample, family) %>%
  summarize(read_prop=sum(read_prop)) %>%
  group_by(family) %>%
  summarize(read_prop=max(read_prop)) %>% 
  filter(read_prop>0.01) %>%
  `[[`("family")

curated_contigs %<>% 
  filter(., family %in% subset_contigs) %>%
  mutate(ska_species=apply(., 1, function (x) ifelse(x["ska_genus"]=="Culiseta", "", x["ska_species"]))) %>% 
  arrange(ska_genus, ska_species, collected_by, desc(read_prop_virus)) %>%
  mutate(sample=factor(sample, levels=as.character(sample) %>% unique())) %>%
  mutate(sample_id=as.numeric(sample))
  
```


# Plot virus and wolbachia results


```{r plot_color_palette, message=FALSE}
collected_by_dict <- c(PLCR="Placer", ALCO="Alameda", WVAL="West Valley", COAV="Coachella Valley", SAND="San Diego", "NA"="NA")

collected_by_colors <- c(PLCR=rgb(0.28098424626331703, 0.63955403192370541, 0.39507882933990629, 0.75), ## green\n",
                          ALCO=rgb(0.49803923567136127, 0.43267975250879925, 0.52287583549817396, 0.75), ## purple\n"
                          WVAL=rgb(0.88366013765335083, 0.77908497055371606, 0.18562091886997223, 0.75), ## yellow\n",
                          COAV=rgb(0.8162552973803352, 0.41062668737243202, 0.29078047883276847, 0.75), ## red\n",
                          SAND=rgb(0.4666666666666667, 0.7450980392156863, 0.8588235294117647, 0.75), ## light blue\n",
                          "NA"="#C0C0C0")

color_palette <- read_tsv(file.path(fig_dir, "virus_color_scheme.tsv"), col_names = c("id", "family", "color")) %>% 
  filter(!duplicated(family)) %>%
  with(setNames(color, family)) %>%
  c(., c(Wolbachia="black", Amblyosporidae="gray75", Apicomplexa="gray50", Trypanosomatidae="gray25")) %>%
  c(., collected_by_colors) 


names(color_palette)

color_palette[c("Flaviviridae", "Narnaviridae", "Virgaviridae", "Solemoviridae", "Luteoviridae", "Tombusviridae", "Nodaviridae", "Iflaviridae", "Dicistroviridae", "Orthomyxoviridae", "Rhabdoviridae", "Xinmoviridae", "Partitiviridae")] <- c("#0074C4", "#57A2F7", "#AFD1FF", "#FDFB2F", "#FDFB2F", "#7AD593", "#7AD593", "#48A365", "#48A365", "#BA0000", "#FF7D48", "#FF7D48", "#965DAE")

```




```{r plot_data, message=FALSE}
base_plot_background_df <- curated_contigs %>% 
  filter(!duplicated(sample)) %>% 
  select(sample, ska_species, collected_by) %>% 
  list(.) %>% 
  mapply(mutate, ., group=as.list(levels(curated_contigs$group)), SIMPLIFY=FALSE) %>%
  do.call(what=rbind) %>%
  mutate(group=factor(group, levels=unique(group))) %>%
  mutate(fill=c("white", "gray80")[factor(paste(ska_species, collected_by), levels=unique(paste(ska_species, collected_by))) %>% as.numeric() %>% `%%`(2) %>% `+`(1)])
base_plot <- 
  ggplot(curated_contigs) +
  theme_bw() + 
  geom_tile(data=base_plot_background_df, aes(x=sample, y=0.5), fill=base_plot_background_df$fill, alpha=.5) +
  geom_bar(aes(x=sample, y=read_prop, fill=family), stat="identity", position="stack", color="white", size=.2) +
  geom_text(data=curated_contigs %>% filter(!duplicated(group)) %>% mutate(group_label=gsub("Other Eukaryotes", "Microscopic\neukaryotes", group)), 
            aes(label=group_label), x=1, y=max(curated_contigs$read_prop)*0.9, hjust=0, lineheight=.75) +
  facet_grid(group~., switch="both") +
  scale_y_continuous(labels=scales::percent, breaks=c(0.25, 0.5, 0.75), minor_breaks=seq(0.05, 1, 0.05)) +
  #scale_alpha_continuous("", range=c(0.0, 0.1)) +
  scale_fill_manual("", breaks=names(color_palette), values=color_palette, labels=names(color_palette)) +
  ylab("% of nonhost reads") +
  xlab("sample ID") +
  theme(legend.position="none",
        strip.background.y=element_blank(),
        strip.text.y=element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.x = element_blank(),
        text=element_text(size=14),
        axis.text.x=element_blank(),
        axis.title.x=element_blank(),
        axis.title.y=element_text(vjust=0.5),
        axis.line=element_line(size=.2),
        plot.margin=unit(c(0, 0, 0, 0), "lines"))
plot_grob <- ggplotGrob(base_plot)
plot_grob$heights[filter(plot_grob$layout, grepl("panel-1-1", name))$t] <- unit(2.5, "null")
```

```{r species_label_grob}
species_label_df <- curated_contigs %>%
  group_by(ska_genus, ska_species) %>% 
  summarize(xmin=min(sample_id), xmax=max(sample_id)) %>% 
  ungroup() %>% 
  mutate(col=as.numeric((1:nrow(.))%%2)) %>%
  mutate(xmin=xmin-0.5, xmax=xmax+0.5) %>%
  mutate(species_label=paste0(substr(ska_genus, 1, 2), ". ", ska_species) %>% 
           gsub("Cu. $", "Culiseta spp.", .) %>% 
           gsub("fasciatus", ".", ., fixed=TRUE) %>% 
           gsub("Ae. dorsalis", "*", .) %>%
           gsub("Cu. ", "Cx. ", ., fixed=TRUE))

species_label_grob <- ggplot(species_label_df) +
  theme_classic() +
  geom_rect(aes(xmin=xmin, xmax=xmax, fill=species_label, ymin=0, ymax=1), color="white", fill="gray") +
  geom_text(aes(x=(xmax+xmin)/2, y=0.5, label=species_label), fontface="italic", size=3) +
  scale_y_continuous(labels=scales::percent) +
  scale_x_continuous(expand = c(0,0)) +
  ylab("% of nonhost reads") +
  theme(axis.line.y=element_line(size=.2, color="white"),
        axis.text.y=element_text(size=14, color="white", ),
        axis.ticks.y=element_line(color="white"),
        axis.title.y=element_text(vjust=0.5, color="white"),
        axis.line.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.x=element_blank(),
        plot.margin=unit(c(0, 0, 0, 0), "lines"))

location_label_grob <- ggplot(curated_contigs %>% filter(!duplicated(sample))) +
  theme_classic() +
  geom_tile(aes(x=sample, fill=collected_by, y=1)) +
  scale_y_continuous(labels=scales::percent) +
  ylab("% of nonhost reads") +
  scale_fill_manual("", breaks=names(color_palette), values=color_palette, labels=names(color_palette)) +
  theme(axis.line.y=element_line(size=.2, color="white"),
        axis.text.y=element_text(size=14, color="white"),
        axis.ticks.y=element_line(color="white"),
        axis.title.y=element_text(vjust=0.5, color="white"),
        axis.line.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.title.x=element_blank(),
        plot.margin=unit(c(0, 0, 0, 0), "lines"),
        legend.position="none")
  

```


```{r plot_legends}
collection_site_plot <- ggplot(curated_contigs, aes(x=sample_short, y=read_prop, fill=collected_by)) + 
  theme_bw() + 
  geom_bar(stat="identity",) +
  scale_fill_manual(breaks=names(collected_by_colors), 
                    labels=collected_by_dict[names(collected_by_colors)], 
                    values=collected_by_colors) +
  guides(fill=guide_legend(title="Collection Sites")) +
  theme(text=element_text(size=10), legend.title=element_text(size=12, face="bold"))
# Extract legends as separate plots
legends <- split(curated_contigs, curated_contigs$baltimore_group) %>%
  lapply(function (dataframe) {
    selected_colours <- names(color_palette) %in% as.character(dataframe$family)
    subpalette <- color_palette[selected_colours]
    sublabels <- names(color_palette)[selected_colours]
    ggplot(dataframe, aes(x=sample_short, y=read_prop, fill=family)) +
      theme_bw() +
      geom_bar(stat="identity", position="stack") +
      scale_fill_manual(gsub("Other ", "Microscopic ", dataframe$genome_description[1]), breaks=sublabels, labels=sublabels, values=subpalette) +
      guides(fill=guide_legend(nrow=2, byrow=TRUE, title.position="top")) +
      theme(text=element_text(size=10), legend.position="top", legend.title=element_text(size=12, face="bold"))
  }) %>%
  c(., list(collection_site=collection_site_plot)) %>%
  lapply(function (plot_x) {
    plot_gtable <- ggplot_gtable(ggplot_build(plot_x))
    leg <- which(sapply(plot_gtable$grobs, function(x) x$name) == "guide-box")
    return (plot_gtable$grobs[[leg]])
  })
```


```{r save_plot}
legends_grob <- arrangeGrob(do.call(what=cbind, legends[c("V", "IV", "III", "Other Eukaryotes")]), nrow=1)
collection_site_grob <- arrangeGrob(rectGrob(gp=gpar(col="white")), legends$collection_site, ncol=1, heights=c(2, 1))
main_plot_grob <- arrangeGrob(arrangeGrob(plot_grob, location_label_grob, species_label_grob, ncol=1, heights=c(40, 2, 3)), collection_site_grob, nrow=1, widths=c(7, 1))
full_plot <- arrangeGrob(legends_grob, main_plot_grob, heights=c(1, 6))
ggsave(file.path(fig_dir, "fig3.pdf"), full_plot, width=unit(18, "in"), height=unit(7, "in"))
```

# Plot prevalence vs abundance of viruses

```{r prev_abundance}
curated_virus_df <- filter(curated_virus_wolbachia_df, group=="Virus") %>%
  left_join(., select(metadata, NewIDseqName, collection_lat, collection_long), by=c("sample"="NewIDseqName"))
viral_bulk_abundance <- curated_virus_df %>%
  group_by(ska_genus, ska_species, collection_lat, collection_long, sci_name) %>%
  summarize(bulk_abundance=mean(read_prop), infected_mosquitos=n()) %>%
  ungroup()
viral_bulk_abundance <- curated_virus_df %>%
  group_by(ska_genus, ska_species, collection_lat, collection_long) %>%
  summarize(num_mosquitos=n_distinct(sample_short)) %>%
  ungroup() %>%
  left_join(viral_bulk_abundance, .) %>% 
  mutate(prevalence=infected_mosquitos/num_mosquitos)
```

```{r prev_abundance_vignettes}
select_viruses_prev_abundance <- 
  filter(viral_bulk_abundance, num_mosquitos>=10) %>%
  filter(bulk_abundance>=0.1, bulk_abundance<=0.2) %>%
  slice(c(which.min(prevalence), which.max(prevalence))) %>%
  list(.) %>%
  mapply(function (i, df) {
    read_prop_df <- data.frame(mosquito_id=1:df$num_mosquitos[i], read_prop=0)
    read_prop_vector <- left_join(df[i, ], curated_virus_df)$read_prop %>% sort(decreasing=TRUE)
    read_prop_df[seq(read_prop_vector), "read_prop"] <- read_prop_vector
    read_prop_df <- left_join(df[i, ] %>% select(-sci_name), curated_virus_df) %>%
      slice(order(read_prop, decreasing=TRUE)) %>%
      `[[`("sample_short") %>%
      unique() %>%
      mutate(read_prop_df, sample_short=.) %>%
      mutate(sample_short=factor(as.character(sample_short), levels=unique(as.character(sample_short))))
    cbind(read_prop_df, df[i, ])
  }, 1:nrow(.[[1]]), ., SIMPLIFY=FALSE) %>%
  do.call(what=rbind, .)
```

```{r prev_abundance_plot}
prev_abundance_plot_df <- filter(viral_bulk_abundance, num_mosquitos>=10) %>%
  left_join(., select_viruses_prev_abundance) %>% 
  mutate(highlight=sci_name)
prev_abundance_plot_df$highlight[is.na(prev_abundance_plot_df$mosquito_id)] <- "NA"
prev_abundance_plot <- 
  ggplot(prev_abundance_plot_df) +
  theme_bw() +
  geom_point(aes(x=bulk_abundance, y=prevalence, color=highlight)) +
  geom_label(data=filter(select_viruses_prev_abundance, !duplicated(paste(ska_genus, ska_species, collection_lat, collection_long, sci_name))) %>%
                           mutate(bulk_abundance=bulk_abundance-c(0.02, 0.095), prevalence=prevalence+c(0.13, -0.07)),
             aes(x=bulk_abundance, y=prevalence, label=paste0(sci_name, "\ncollected at\n", round(collection_lat, 2), ", ", round(collection_long, 2)), fill=sci_name),
             hjust=0.5, alpha=.75) +
  scale_x_log10(labels=scales::percent) +
  scale_y_continuous(labels=scales::percent) +
  scale_color_manual(values=c("black", "indianred1", "skyblue2")) +
  scale_fill_manual(values=c("indianred1", "skyblue2")) +
  xlab("bulk abundance") + 
  ylab("prevalence") +
  ggtitle("A)") +
  theme(legend.position="none", text=element_text(size=12))
```


```{r prev_abundance_vignettes_plot}
select_virus_prev_abund_plot <- ggplot(select_viruses_prev_abundance, aes(x=sample_short, y=read_prop)) +
  theme_bw() +
  geom_bar(stat="identity") +
  geom_hline(aes(yintercept=bulk_abundance), color="darkmagenta") +
  facet_grid(.~paste0(sci_name, " collected at ", round(collection_lat, 2), ",", round(collection_long, 2)), scales="free_x", space="free") +
  scale_y_continuous(labels=scales::percent) +
  xlab("Sample") + ylab("% nonhost\nreads") +
  ggtitle("B)") +
  theme(axis.text.x=element_text(angle=90))
```

```{r prev_abundance_combined_plot}
ggsave(file.path(fig_dir, "../supplementary/virus_prev_abundance.pdf"), arrangeGrob(prev_abundance_plot, select_virus_prev_abund_plot, ncol=1, heights=c(6, 4)),
       width=unit(8, "in"), height=unit(6.5, "in"))
```


# Save output

```{r output}
save.image(file="generate_figures.RData")
```

