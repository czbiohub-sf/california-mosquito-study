---
title: "Generate figures"
author: "Lucy M. Li"
date: "`r format(Sys.Date(), '%b %d, %Y')`"
output: 
  html_document:
    fig_caption: yes
---


# Notebook setup

Run this notebook after running the generate_figures.ipynb jupyter notebook.

```{r setup, include=FALSE}
# List of packages to load
pkgs <- c("parallel", "dplyr", "tidyr", "readr", "magrittr", "ggplot2", "grid", "gridExtra", "stringr", "reutils", "rjson", "knitr", "taxize", "aws.s3", "RColorBrewer")
# Install any packages not yet installed
if (any(!(pkgs %in% rownames(installed.packages())))) {
  invisible(sapply(pkgs[!(pkgs %in% rownames(installed.packages()))], install.packages))
}
# Load the libraries
invisible(sapply(pkgs, library, character.only=TRUE))
# R Markdown options
knitr::opts_chunk$set(echo=TRUE)
```

```{r directories}
data_dir <- "../../data/metadata"
fig_dir <- "../../figures/fig3"
if (!dir.exists(data_dir)) dir.create(data_dir)
if (!dir.exists(fig_dir)) dir.create(fig_dir)
```


```{r scripts}
source("generate_figures_functions.R")
```

# Metadata

```{r load_data}
metadata_file_path <- list.files(data_dir, "CMS001_CMS002_Merged", full.names = TRUE)
metadata <- read.csv(metadata_file_path, stringsAsFactors = FALSE) %>%
  mutate(collected_by=gsub(" ", "", collected_by)) %>%
  mutate(collection_date=as.Date(collection_date)) %>%
  mutate(ska_genus_species=paste(ska_genus, ska_species))
```


# Read in data



```{r read_in_data, message=FALSE}
curated_contigs <- read_tsv(file.path(fig_dir, "all_contigs_df.tsv")) %>%
  mutate(collected_by=factor(collected_by, levels=c("PLCR", "ALCO",  "WVAL", "COAV", "SAND")),
         group=factor(group, levels=c("Virus", "Wolbachia", "Metazoa", "Other Eukaryotes")))
curated_contigs %<>% 
  filter(group=="Virus") %>% group_by(sample) %>% summarize(read_prop_virus=sum(read_prop)) %>% left_join(curated_contigs, .) %>%
  arrange(group, ska_genus, ska_species, desc(collected_by), desc(read_prop_virus)) %>%
  mutate(sample_short=str_split(as.character(sample), "_", simplify=FALSE) %>% lapply(head, 2) %>% sapply(paste, collapse="_") %>% gsub("CMS00", "", .)) %>%
  mutate(sample_short=factor(sample_short, levels=unique(sample_short)))

```


# Plot results

```{r plot_color_palette, message=FALSE}
color_palette <- split(curated_contigs$sci_name, curated_contigs$group) %>% 
  lapply(unique) %>%
  lapply(function (x) {
    if (length(x)==1) {
      colors <- c("gray20")
    } else {
      colors <- brewer.pal(length(x), name="Paired")
    }
    names(colors) <- x
    colors
  }) %>%
  do.call(what=c)
renamed_color_palette <- unname(color_palette)
names(renamed_color_palette) <- strsplit(names(color_palette), ".", fixed=TRUE) %>% sapply(tail, 1)
legend_labels <- names(renamed_color_palette)
legend_labels[match(c("Viruses", "Wolbachieae", "Eukaryota", "Metazoa"), legend_labels)] <- c("Other viruses", "Wolbachia", "Other eukaryotes", "Other metazoa")
```




```{r plot_data, message=FALSE}
plot <- 
  ggplot(curated_contigs, aes(x=sample_short, y=read_prop, fill=sci_name)) +
  theme_bw() + 
  geom_bar(stat="identity", position="stack") +
  facet_grid(group~ska_genus+ska_species+collected_by, scales='free', space="free_x") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual("", breaks=names(renamed_color_palette), values=renamed_color_palette, labels=legend_labels) +
  ylab("% of nonhost reads") +
  xlab("sample ID") +
  theme(axis.text.x=element_text(angle=90, hjust=1), 
        legend.position="none",
        strip.text.y=element_text(angle=0),
        axis.title.y=element_text(angle=0, vjust=0.5),
        text=element_text(size=16))
```

```{r plot_legends}
legends <- split(curated_contigs, curated_contigs$group) %>%
  lapply(function (dataframe) {
    selected_colours <- names(renamed_color_palette) %in% as.character(dataframe$sci_name)
    subpalette <- renamed_color_palette[selected_colours]
    sublabels <- legend_labels[selected_colours]
    subbreaks <- names(renamed_color_palette)[selected_colours]
    temp_plot <- ggplot(dataframe, aes(x=sample_short, y=read_prop, fill=sci_name)) +
      theme_bw() +
      geom_bar(stat="identity", position="stack") +
      scale_fill_manual("", breaks=subbreaks, labels=sublabels, values=subpalette) +
      theme(text=element_text(size=16))
    plot_gtable <- ggplot_gtable(ggplot_build(temp_plot))
    leg <- which(sapply(plot_gtable$grobs, function(x) x$name) == "guide-box") 
    plot_gtable$grobs[[leg]]
  })
```

```{r save_plot}
full_plot <- arrangeGrob(plot, arrangeGrob(grobs=legends, ncol=1), nrow=1, widths=c(9, 1))
ggsave(file.path(fig_dir, "fig3.pdf"), full_plot, width=20, height=20)
```

## Save output

```{r output}
save.image(file="generate_figures.RData")
```

