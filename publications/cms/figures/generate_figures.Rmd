---
title: "Generate figures"
author: "Lucy M. Li"
date: "12/17/2018"
output: 
  html_document:
    fig_caption: yes
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
library(parallel)
library(dplyr)
library(tidyr)
library(readr)
library(magrittr)
library(ggplot2)
library(grid)
library(gridExtra)
library(broom)
library(sp)
library(rgdal)
library(maptools)
library(OpenStreetMap)
library(ggmap)
library(reutils)
library(XML)
library(xtable)
library(tibble)
library(stringr)
library(ape)
library(seqinr)
library(ggtree)
library(grid)
library(gridExtra)
library(kmer)
library(rjson)
# Attention!
# Google has recently changed its API requirements, and ggmap users are now required to provide an API key and enable billing. ggmap itself is outdated on CRAN; we hope to have the new version up on CRAN soon, but until then, here is the workaround:
# 
# if(!requireNamespace("devtools")) install.packages("devtools")
# devtools::install_github("dkahle/ggmap", ref = "tidyup")
# When you load ggmap, you can set your API key with register_google() (see ?register_google for details), but donâ€™t forget to enable the Maps Static API and geocoding API in the Google Cloud Console and enable billing. Also, go to 'Quotas' on Google Cloud and increase the 'Unsigned requests (if URL signing secret is defined) per day' limit
# See #51 on dkhale/ggmap github page for an extended discussion on details.
# register_google(key="AIzaSyAPP_DRq_N6XZyO7r2ad_-eQw36I_wFWio")
# Requires inputting billing information to increase limit to more than 1 request per day
# For now, use 'stamen' maps instead

```

```{r directories}
data_dir <- "../../../data"
blast_headers <- c("qseqid", "sseqid", "pident", "length", "mismatch", "gapopen", 
"qstart", "qend", "sstart", "send", "evalue", "bitscore")
```

```{r scripts}
source("generate_figures_functions.R")
```

# 1. Demographics

```{r load_data}
metadata <- read.csv(list.files(data_dir, "CMS001_CMS002_Merged", full.names = TRUE), stringsAsFactors = FALSE) %>%
  mutate(collected_by=gsub(" ", "", collected_by)) %>%
  mutate(collection_long=mapply(ifelse, collection_long < -1e3, collection_long/1e7, collection_long)) %>%
  mutate(collection_date=as.Date(collection_date)) %>%
  mutate(compute_genus_species=paste(compute_genus, compute_species)) %>% 
  left_join(., read.csv(file.path(data_dir, "project-mosquito_sample-table.csv")) %>% rename(NewIDseqName=sample_name) %>% select(NewIDseqName, total_reads, nonhost_reads, subsampled_fraction, total_ercc_reads, nucleotide_type))

total_mosquito_nonhost_reads <- metadata %>%
  filter(., !grepl("ater", compute_genus_species)) %>%
  group_by(, compute_genus_species, collected_by) %>%
  summarize(total_mosquitos=n(), total_nonhost=sum(nonhost_reads))

summary_metadata <- metadata %>%
  filter(!is.na(collected_by)) %>%
  group_by(collected_by, compute_genus_species) %>%
  summarize(n=n()) %>%
  spread(key=compute_genus_species, value=n, fill=0) %>%
  left_join(group_by(metadata, collected_by) %>% summarize_at(paste0("collection_", c("lat", "long")), mean, na.rm=TRUE), by="collected_by") %>%
  mutate(collected_by_display=c(ALCO="Alameda", PLCR="Placer", WVAL="West Valley", COAV="Coachella Valley", SAND="San Diego")[collected_by])
write.csv(summary_metadata, "01_demographics/summary_metadata.csv", quote=FALSE, row.names=FALSE)
```

```{r map_data}
zoom_options <- get_zoom_options (NULL, metadata$collection_long, metadata$collection_lat, multiplier=0.2)
cal_map <- openmap(c(zoom_options$lat_range[2], zoom_options$lon_range[1]),
                   c(zoom_options$lat_range[1], zoom_options$lon_range[2]), 
                   zoom = zoom_options$zoom, type = "osm", mergeTiles = TRUE) %>%
  openproj(projection = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")
cal_map_plot <- autoplot(cal_map) + theme_nothing() +
  geom_point(data=summary_metadata, aes(x=collection_long, y=collection_lat)) +
  geom_segment(data=summary_metadata, aes(x=collection_long, xend=collection_long, y=collection_lat, yend=collection_lat+0.3), color="grey40") +
  geom_label(data=summary_metadata, aes(x=collection_long, y=collection_lat+0.3, label=collected_by_display), vjust=0)
sapply(c("png", "pdf"), function (x) ggsave(paste0("01_demographics/california_map.", x), cal_map_plot, width=5, height=5)) %>% invisible()
```

```{r map_plot, fig.asp=`r diff(zoom_options$lat_range)/diff(zoom_options$lon_range)`}
cal_map_plot
```

# 2. mNGS analysis

# 3. Microbiota overview

```{r microbiome, cache=TRUE, warning=FALSE, message=FALSE}
blast_results <- read_tsv(file.path(data_dir, "full_lca_results.txt"))
```


```{r viral_reads, message=FALSE, warning=FALSE, cache=TRUE, fig.width=15, fig.height=30}
viral_contigs <- read_tsv(file.path(data_dir, "viral_contigs.txt")) %>%
  left_join(., metadata, by=c("sample"="NewIDseqName"), suffix=c("", ".y")) %>%
  select(-ends_with(".y"))
close_viral_hits <- viral_contigs %>%
  filter(., align_prop > 0.8/3, identity > 80)
close_viral_hits_per_mosquito <- close_viral_hits %>%
  filter(., !grepl("ater", sample)) %>%
  group_by(., sample, sci_name) %>% summarize(taxid=head(taxid, 1), compute_genus_species=head(compute_genus_species, 1), collected_by=head(collected_by, 1), read_count=sum(read_count), nonhost_read_count=head(nonhost_reads, 1))
close_viral_hits_prevalence <- close_viral_hits %>%
  filter(., !grepl("ater", sample)) %>%
  group_by(., sci_name, compute_genus_species, collected_by) %>%
  summarize(., taxid=head(taxid, 1), total_reads=sum(read_count), infected_mosquitos=length(unique(sample))) %>%
  left_join(., total_mosquito_nonhost_reads, by=c("compute_genus_species", "collected_by")) %>%
  ungroup() %>%
  left_join(close_viral_hits_per_mosquito, ., by=c("compute_genus_species", "collected_by", "taxid"), suffix=c("", ".y")) %>%
  select(., -ends_with(".y")) %>%
  mutate(sci_name=factor(sci_name, levels=group_by(., sci_name) %>% summarise_at("infected_mosquitos", sum) %>% with(., sci_name[order(infected_mosquitos, decreasing = TRUE)])))

close_viral_hits_prevalence_plot <- 
  close_viral_hits_prevalence %>%
  group_by(., sci_name, compute_genus_species, collected_by) %>%
  do(., head(., 1)) %>%
  split(., .$sci_name) %>%
  lapply(function (x) {
    ggplot(x) + theme_bw() +
      geom_bar(aes(x=compute_genus_species, y=total_reads/total_nonhost), stat="identity") +
      facet_wrap(~collected_by, nrow=1) +
      scale_y_continuous(labels = scales::percent) +
      ggtitle(x$sci_name[1])
  })
ggsave("03_microbiota_overview/viral_abundance_prevalence_geo_species.pdf",
       arrangeGrob(grobs=close_viral_hits_prevalence_plot, ncol=3),
       width=10, height=30)
```



```{r viral_hits, fig.width=7, fig.height=15}
close_viral_hits_prev_abundance_plot <- close_viral_hits_prevalence %>%
  split(., .$sci_name) %>%
  lapply(function (df_x) {
    geom_text_df <- group_by(df_x, collected_by, compute_genus_species)%>%do(., .[which.max(.$read_count/.$nonhost_read_count), ])
    ggplot(df_x, aes(x=collected_by)) + theme_bw() +
      geom_bar(aes(y=total_reads/total_nonhost), stat="identity", position="dodge") +
      geom_point(aes(y=read_count/nonhost_read_count), position = position_dodge(width = 1)) +
      geom_text(data=geom_text_df, aes(label = paste(infected_mosquitos, total_mosquitos, sep="/"), y = max(read_count/nonhost_read_count)*1.05), position = position_dodge(0.9), vjust = 0) +
      xlab("Collection Sites") + ylab("Percentage of nonhost reads") +
      facet_wrap(~compute_genus_species, nrow=1, scales="free_x") +
      scale_y_continuous(labels=scales::percent) +
      scale_color_manual(values=rep("black", length(unique(close_viral_hits_prevalence$collected_by)))) +
      ggtitle(df_x$sci_name[1])
  }) %>%
  arrangeGrob(grobs=., ncol=3)
ggsave("03_microbiota_overview/close_viral_hits_prev_abundance_plot.pdf",
       close_viral_hits_prev_abundance_plot,
       width=35, height=49)
```


```{r virome-heatmap, fig.width=10, fig.height=5}
ggplot(close_viral_hits_prevalence) + theme_bw() +
  geom_tile(aes(x=sample, y=sci_name, fill=read_count/nonhost_read_count*100)) +
  scale_fill_gradient2("% nonhost reads", low="#FFFFCC", mid="#FFD700", high="#f03b20")
```


# 4. Bloodmeal

```{r}

```

```{r chordate_hits}

```



# 5. Vignettes



