---
title: "Generate figures"
author: "Lucy M. Li"
date: "12/17/2018"
output: 
  html_document:
    fig_caption: yes
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
library(dplyr)
library(tidyr)
library(readr)
library(magrittr)
library(ggplot2)
library(sp)
library(OpenStreetMap)
library(ggmap)
library(DiagrammeR)
# Attention!
# Google has recently changed its API requirements, and ggmap users are now required to provide an API key and enable billing. ggmap itself is outdated on CRAN; we hope to have the new version up on CRAN soon, but until then, here is the workaround:
# 
# if(!requireNamespace("devtools")) install.packages("devtools")
# devtools::install_github("dkahle/ggmap", ref = "tidyup")
# When you load ggmap, you can set your API key with register_google() (see ?register_google for details), but donâ€™t forget to enable the Maps Static API and geocoding API in the Google Cloud Console and enable billing. Also, go to 'Quotas' on Google Cloud and increase the 'Unsigned requests (if URL signing secret is defined) per day' limit
# See #51 on dkhale/ggmap github page for an extended discussion on details.
# register_google(key="AIzaSyAPP_DRq_N6XZyO7r2ad_-eQw36I_wFWio")
# Requires inputting billing information to increase limit to more than 1 request per day
# For now, use 'stamen' maps instead

```

```{r directories}
data_dir <- "../../../data"
```

```{r scripts}
source("generate_figures_functions.R")
```

# 1. Demographics

```{r load_data}
species_calls <- read.csv(file.path(data_dir, "sample_genus_and_species.csv"),
                          stringsAsFactors = FALSE) %>%
  rename(sample_name=X)
metadata <- read.csv(file.path(data_dir, "project-mosquito_sample-table_cleaned.csv"),
                     stringsAsFactors = FALSE) %>%
  left_join(., species_calls, "sample_name")
```

```{r create-data-frames}
cms_all_data <- filter(metadata, !is.na(lat), grepl("^CMS", sample_name))
cms_all_data[is.na(cms_all_data$genus), c("genus", "species", "corrected.genus", "corrected.species")] <- 
  data.frame(genus="Culex", species=c("erythrothorax", "tarsalis"),
             corrected.genus="Culex", corrected.species=c("erythrothorax", "tarsalis"),
             stringsAsFactors = FALSE)
cms001_metadata <- filter(cms_all_data, grepl("^CMS_[0-9][0-9][0-9]_RNA", sample_name))
cms002_metadata <- filter(cms_all_data, grepl("^CMS_002_[0-9]", sample_name))
locations <- data.frame(names=c("Alameda", "Sacramento", "Los Angeles", "San Diego", "Riverside"),
                        long=c(-122.0865, -121.3544, -117.6627, -117.0832, -116.0492),
                        lat=c(37.59137, 38.80646, 33.99345, 32.73910, 33.52882),
                        stringsAsFactors = FALSE)
set.seed(1000)
cluster_results <- with(cms_all_data, data.frame(long, lat)%>%kmeans(x=., nrow(locations), nstart=10))
cms_all_data$location <- cluster_results$cluster
cms_all_data$location_name <- sapply(1:nrow(locations), function (i) {
  sapply(1:nrow(locations), function (j) {
    calc_eucl_dist(cluster_results$centers[i, 1:2], locations[j, -1])
  }) %>%
    which.min() %>%
    `[`(locations, ., "names")
}) %>%
  `[`(., cms_all_data$location)
```


```{r maps, cache=TRUE}
cms001_map <- create_map(cms001_metadata) + ggtitle("CMS001")
cms002_map <- create_map(cms002_metadata) + ggtitle("CMS002")
cms_summary_map <- create_summary_map(cms_all_data) + ggtitle("CMS") 
cms_location_maps <- split_by_location(cms_all_data) %>%
  mapply(function (plot_df, plot_title) create_map(plot_df) + ggtitle(plot_title),
         ., names(.), SIMPLIFY=FALSE)

demo_fig_dim <- list(width=5, height=5)
ggsave("01_demographics/cms001_map.pdf", cms001_map, 
       width=demo_fig_dim$width,
       height=demo_fig_dim$height)
ggsave("01_demographics/cms002_map.pdf", cms002_map, 
       width=demo_fig_dim$width,
       height=demo_fig_dim$height)
ggsave("01_demographics/cms_summary_map.pdf", cms_summary_map, 
       width=demo_fig_dim$width,
       height=demo_fig_dim$height)
lapply(cms_location_maps, function (x) {
  ggsave(paste0("01_demographics/cms_", x$labels$title,"_map.pdf"), x, 
       width=demo_fig_dim$width,
       height=demo_fig_dim$height)
})

```

```{r demographics-tables}
species_by_location <- cms_all_data %>%
  group_by(., location_name, corrected.genus, corrected.species) %>%
  summarize(., n=n())
species_by_location_plot <- 
  ggplot(species_by_location, 
       aes(x=paste0(corrected.genus, "\n", corrected.species), 
           y=factor(location_name, levels=c("San Diego", "Riverside", "Los Angeles", "Alameda", "Sacramento")), 
           fill=n)) +
  theme_light() +
  geom_tile() +
  facet_grid(.~corrected.genus, scales="free_x") +
  xlab("Species") +
  ylab("Location") +
  scale_fill_continuous("Number of\nSamples")
ggsave("01_demographics/species_by_location.pdf", species_by_location_plot, width=12, height=4)

species_by_location %>%
  mutate(species_name=paste(corrected.genus, corrected.species)) %>%
  spread(., key=species_name, value=n, fill=0) %>%
  `[`(., , -2:-3) %>%
  write_csv(., "01_demographics/demographics.csv")
```

# 2. mNGS analysis

```{r mNGS}
# mNGS analysis pipeline
# Placeholder diagram for now
DiagrammeR::mermaid("
graph TD
  id1[raw reads]--filtering--> reads 
  reads --assembly --> id2[contigs] 
", height=200)
```


# 3. Microbiota overview




# 4. Bloodmeal

# 5. Vignettes



